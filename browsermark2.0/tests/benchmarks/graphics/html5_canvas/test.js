var guide={isDoable:false,operations:0,time:0,internalCounter:true,testName:"Graphics HTML5 Canvas",testVersion:"2.0",compareScore:5173.6,isConformity:0};var ballPhysicsTest;var debugData={};var test={init:function(){
//$.ajax({url:"/ajax/set_test",async:false,type:"POST",data:{test_name:guide.testName,test_version:guide.testVersion}});
if(Modernizr.canvas){guide.isDoable=true;guide.operations=1;try{var b=document.getElementById("tutorial");if(b.getContext){var a=b.getContext("2d");ballPhysicsTest=new CanvasTest(a)}}catch(c){guide.isDoable=false}}return guide},run:function(b,a){draw();testStats()}};function draw(){if(benchmark.elapsedTime()>=15000){var c=ballPhysicsTest.getStats();var a=benchmark.elapsedTime();var d=Math.round(a/1000);var b=c.primitiveCount/a*1000;debugData["second_"+d]=["frameCount: "+c.frameCount,"internalRenderTime: "+c.renderTime,"internalUpdateTime: "+c.updateTime,"internalTotalTime: "+c.totalTime,"benchmarkTime: "+a,"primitiveCount: "+c.primitiveCount,"primitivePerSecond: "+b];counter=c.primitiveCount;$("canvas").remove();clearTimeout(timerDraw);a=benchmark.elapsedTime();finalScore=counter/a*1000;debugData.elapsedTime=a;debugData.operations=counter;debugData.ops=finalScore;benchmark.submitResult(finalScore,guide,debugData)}else{ballPhysicsTest.draw();timerDraw=setTimeout("draw()",1)}}function testStats(){if(benchmark.elapsedTime()<14000){var c=ballPhysicsTest.getStats();if(c.primitiveCount>0){var a=benchmark.elapsedTime();var d=Math.round(a/1000);var b=c.primitiveCount/a*1000;debugData["second_"+d]=["frameCount: "+c.frameCount,"internalRenderTime: "+c.renderTime,"internalUpdateTime: "+c.updateTime,"internalTotalTime: "+c.totalTime,"benchmarkTime: "+a,"primitiveCount: "+c.primitiveCount,"primitivePerSecond: "+b]}timerStats=setTimeout("testStats()",982)}else{clearTimeout(timerStats)}}var Statistics=function(){this.reset()};Statistics.prototype.reset=function(){this.frameCount=0;this.renderTime=0;this.updateTime=0;this.totalTime=0;this.primitiveCount=0};Statistics.prototype.addPrimitive=function(){++this.primitiveCount};Statistics.prototype.addFrame=function(a,b){++this.frameCount;this.renderTime+=b;this.updateTime+=a;this.totalTime=this.renderTime+this.updateTime};var Stats;var physScale=10;var randomSeed=1;var random=function(){var a=[0.0976592,0.558489,0.741295,0.412519,0.493332,0.20716,0.977569,0.0885342,0.515885,0.372387,0.628986,0.155705,0.861415,0.860805,0.0907926,0.483505,0.255867,0.99118,0.4167,0.380078,0.867153,0.482955,0.27897,0.836909,0.195837,0.908963,0.235145,0.853664,0.725944,0.86874,0.832759,0.249336,0.116062,0.539048,0.582873,0.866054,0.213477,0.757561,0.334452,0.571551,0.671346,0.295785,0.0800501,0.966826,0.450728,0.47795,0.724448,0.205145,0.988861,0.801691,0.84753,0.828639,0.314158,0.716941,0.992492,0.0284738,0.890622,0.219337,0.510605,0.235603];randomSeed=(randomSeed+1)%a.length;return a[randomSeed]};var screenToPhys=function(a){return a/physScale};var physToScreen=function(a){return a*physScale};var rgba=function(f,e,c,d){if(d<=0){return"rgba("+f+","+e+","+c+",0.0)"}if(d>=1){return"rgb("+f+","+e+","+c+")"}return"rgba("+f+","+e+","+c+","+d+")"};var lineColor=function(a){return rgba(0,214,255,a)};var HitEffect=function(b,a){this.posX=b;this.posY=a;this.TTL=0};HitEffect.prototype.draw=function(c){var b=6;var a=35;var e=1;this.TTL+=e;var f=0;for(var d=this.TTL;d>=1;d=d-b){++f;if(f<=(b/2)){c.beginPath();c.arc(this.posX,this.posY,d,0,2*Math.PI,false);c.strokeStyle=lineColor(1-(d/a));c.lineWidth=2;Stats.addPrimitive();c.stroke()}}return f<b+1};var HitEffectController=function(){this.effects=new Array()};HitEffectController.prototype.draw=function(a){for(var b=0;b<this.effects.length;++b){this.effects[b].draw(a);if(this.effects[b].draw(a)==false){this.effects.pop();--b}}};HitEffectController.prototype.hasSimilar=function(e,d){for(var c=0;c<this.effects.length;++c){var b=Math.abs(this.effects[c].posX-e);var a=Math.abs(this.effects[c].posY-d);if(b<25&&a<25){this.effects.posX=(this.effects.posX+e)/2;this.effects.posY=(this.effects.posY+d)/2;return true}}return false};HitEffectController.prototype.add=function(b,a){if(false==this.hasSimilar(b,a)){this.effects.unshift(new HitEffect(b,a))}};var Ball=function(f,c,a,h,e,i,g){this.radius=h;this.speed=e;var d=new b2CircleDef();d.density=10;d.radius=screenToPhys(h);d.restitution=i;d.friction=g;var b=new b2BodyDef();b.AddShape(d);b.position.Set(screenToPhys(c),screenToPhys(a));b.linearVelocity=new b2Vec2(2*(random()-0.5),2*(random()-0.5));b.linearVelocity.Normalize();b.linearVelocity.x*=screenToPhys(e);b.linearVelocity.y*=screenToPhys(e);this.body=f.CreateBody(b);this.prevVelocity=this.body.GetLinearVelocity().Copy();this.prevVelocity.Normalize();this.collisionPosition=new b2Vec2(0,0);this.prevPos=new b2Vec2(c,a);this.trajectories=new Array();this.trajectories[this.trajectories.length]=new b2Vec2(c,a)};Ball.prototype.detectCollision=function(){var a=this.body.GetLinearVelocity().Copy();a.Normalize();this.collisionPosition=a.Copy();this.collisionPosition.Subtract(this.prevVelocity);var b=false;if(this.collisionPosition.Length()>0.05){this.collisionPosition.Normalize();var c=this.body.GetCenterPosition().Copy();c.Multiply(physToScreen(1));this.trajectories[this.trajectories.length]=this.prevPos.Copy();this.collisionPosition.Multiply(-this.radius);this.collisionPosition.Add(c);b=true}this.prevVelocity=a.Copy();return b};Ball.prototype.drawTrajectories=function(p){var k=400;var b=physToScreen(this.body.GetCenterPosition().x);var a=physToScreen(this.body.GetCenterPosition().y);this.prevPos.x=b;this.prevPos.y=a;var n=new b2Vec2(b,a);var o=0;for(var h=this.trajectories.length-1;h>=0;--h){var m=this.trajectories[h].Copy();m.Subtract(n);var d=m.Length();var g=0.999-(o/k);if(g>0){var l=0.999-((o+d)/k);var c=1;if(l<0){l=0;c=(k-o)/d;if(c>1){c=1}}p.beginPath();p.lineWidth=3;p.lineCap="butt";p.moveTo(n.x,n.y);var f=p.createLinearGradient(n.x,n.y,this.trajectories[h].x,this.trajectories[h].y);f.addColorStop(0,lineColor(g));f.addColorStop(c,lineColor(l));g=l;p.strokeStyle=f;p.lineTo(this.trajectories[h].x,this.trajectories[h].y);Stats.addPrimitive();p.stroke();n.x=this.trajectories[h].x;n.y=this.trajectories[h].y}else{for(var e=0;e<h;++e){this.trajectories.shift()}}o+=d}};Ball.prototype.draw=function(b){var f=this.body.GetLinearVelocity();f.Normalize();f.x*=screenToPhys(this.speed);f.y*=screenToPhys(this.speed);this.body.SetLinearVelocity(f);var h=this.body.GetRotation();var c=Math.PI*2;var g=physToScreen(this.body.GetCenterPosition().x);var e=physToScreen(this.body.GetCenterPosition().y);this.drawTrajectories(b);b.beginPath();b.arc(g,e,this.radius+6,h,h+c,false);var a=b.createRadialGradient(g,e,this.radius+2,g,e,this.radius+6);a.addColorStop(0,lineColor(0.35));a.addColorStop(1,lineColor(0));b.fillStyle=a;Stats.addPrimitive();b.fill();b.beginPath();b.arc(g,e,this.radius,h,h+c,false);b.fillStyle="#101010";Stats.addPrimitive();b.fill();var d=this.body.GetWorldPoint(new b2Vec2(screenToPhys(-this.radius),0));b.lineTo(physToScreen(d.x),physToScreen(d.y));b.strokeStyle=lineColor(1);b.lineWidth=2;Stats.addPrimitive();b.stroke()};var Box=function(i,c,b,j,g,f,h,d){this.sizeX=g;this.sizeY=f;var e=new b2BoxDef();e.extents.Set(screenToPhys(g*0.5),screenToPhys(f*0.5));e.restitution=h;e.friction=d;var a=new b2BodyDef();a.AddShape(e);a.position.Set(screenToPhys(c),screenToPhys(b));a.rotation=j;this.body=i.CreateBody(a)};Box.prototype.draw=function(b){var e=physToScreen(this.body.GetCenterPosition().x);var d=physToScreen(this.body.GetCenterPosition().y);var c=this.body.GetRotation();b.translate(e,d);b.rotate(c);var a=20;b.beginPath();b.moveTo(0,-this.sizeY*0.5+this.sizeX*0.5);b.lineTo(0,this.sizeY*0.5-this.sizeX*0.5);b.lineWidth=a;b.lineCap="round";b.strokeStyle=lineColor(0.15);Stats.addPrimitive();b.stroke();b.lineWidth=a+2;Stats.addPrimitive();b.stroke();b.strokeStyle=lineColor(0.08);b.lineWidth=a+4;Stats.addPrimitive();b.stroke();b.strokeStyle=lineColor(0.08);b.lineWidth=a+8;Stats.addPrimitive();b.stroke();b.strokeStyle=lineColor(0.04);b.lineWidth=a+12;Stats.addPrimitive();b.stroke();b.beginPath();b.rect(-this.sizeX*0.5,-this.sizeY*0.5,this.sizeX,this.sizeY);b.lineWidth=2;b.strokeStyle=lineColor(1);b.fillStyle="#101010";Stats.addPrimitive();b.fill();Stats.addPrimitive();b.stroke();b.rotate(-c);b.translate(-e,-d)};var GridImpulse=function(b,a,c){this.reset(b,a,c)};GridImpulse.prototype.reset=function(b,a,c){this.impulsePosX=b;this.impulsePosY=a;this.delta=c};GridImpulse.prototype.drawImpulse=function(j,b,a,i,h){var g=Math.round(b-i);var f=Math.round(a-h);var e=Math.round(b);var d=Math.round(a);var c=j.createLinearGradient(g,f,e,d);c.addColorStop(1,rgba(255,255,255,1));c.addColorStop(0,lineColor(0));j.strokeStyle=c;j.lineWidth=2;j.beginPath();j.moveTo(b-i,a-h);j.lineTo(b,a);Stats.addPrimitive();j.stroke();j.beginPath();j.arc(b,a,3,0,Math.PI*2,false);var c=j.createRadialGradient(b,a,0,b,a,3);c.addColorStop(0,rgba(255,255,255,1));c.addColorStop(1,lineColor(0));j.fillStyle=c;Stats.addPrimitive();j.fill();j.closePath()};GridImpulse.prototype.drawHorizontal=function(a){var b=20;this.impulsePosX+=b;var c=this.delta*b;this.impulsePosY+=c;this.drawImpulse(a,this.impulsePosX,this.impulsePosY,b,b*this.delta);if(this.impulsePosX>3900){return false}return true};GridImpulse.prototype.drawVertical=function(a){var b=20;this.impulsePosY-=b;var c=this.delta*b;this.impulsePosX+=c;this.drawImpulse(a,this.impulsePosX,this.impulsePosY,b*this.delta,-b);if(this.impulsePosY<-1210){return false}return true};var Level=function(k,d,b,f,a){this.boxes=new Array();var g=d*b/(1000*600);var c=g*12;var n=c*0.5;this.boxes[0]=new Box(k,-n,b*0.5,0,c,b,f,a);this.boxes[1]=new Box(k,d+n,b*0.5,0,c,b,f,a);this.boxes[2]=new Box(k,d*0.5,-n,Math.PI*0.5,c,d,f,a);this.boxes[3]=new Box(k,d*0.5,b+n,Math.PI*0.5,c,d,f,a);this.boxes[4]=new Box(k,d*0.8,b*0.75,Math.PI*0.25,c,g*200,f,a);this.boxes[5]=new Box(k,d*0.2,b*0.75,-Math.PI*0.25,c,g*200,f,a);this.boxes[6]=new Box(k,d*0.8,b*0.25,-Math.PI*0.25,c,g*200,f,a);this.boxes[7]=new Box(k,d*0.2,b*0.25,Math.PI*0.25,c,g*200,f,a);this.verticalGridStarts=new Array();this.verticalGridDeltas=new Array();this.horizontalGridStarts=new Array();this.horizontalGridDeltas=new Array();var e=0.5;var l=-2500;for(var h=0;h<26;++h){this.verticalGridStarts[h]=60+h*(80-h*0.9);var o=(e*l)-this.verticalGridStarts[h];var m=b-l;this.verticalGridDeltas[h]=o/m}var e=44;var l=60;for(var h=0;h<15;++h){this.horizontalGridStarts[h]=-15+h*(40+h*1.7);var o=(e*l)-0;var m=l-this.horizontalGridStarts[h];this.horizontalGridDeltas[h]=m/o}var j=random()*this.horizontalGridDeltas.length-1;this.horizontalGridImpulse=new GridImpulse(0,this.horizontalGridStarts[7],this.horizontalGridDeltas[7]);var j=random()*this.verticalGridDeltas.length-1;this.verticalGridImpulse=new GridImpulse(this.verticalGridStarts[25],b,this.verticalGridDeltas[25])};Level.prototype.generateHorizontalGridImpulse=function(){var a=Math.round(random()*(this.horizontalGridStarts.length-1));a%=this.horizontalGridStarts.length;var c=this.horizontalGridStarts[a];var b=this.horizontalGridDeltas[a];this.horizontalGridImpulse=new GridImpulse(0,c,b)};Level.prototype.generateVerticalGridImpulse=function(){var a=Math.round(random()*(this.verticalGridStarts.length-1));a%=this.verticalGridStarts.length;var c=this.verticalGridStarts[a];var b=this.verticalGridDeltas[a];this.verticalGridImpulse=new GridImpulse(c,600,b)};drawLine=function(c,b,a,e,d){c.beginPath();c.moveTo(b,a);c.lineTo(e,d);c.lineWidth=2;c.strokeStyle=lineColor(0.1);Stats.addPrimitive();c.stroke();c.lineWidth=14;c.strokeStyle=lineColor(0.008);Stats.addPrimitive();c.stroke()};Level.prototype.draw=function(a){for(var b=0;b<this.horizontalGridStarts.length;++b){drawLine(a,0,this.horizontalGridStarts[b],1000,this.horizontalGridStarts[b]+this.horizontalGridDeltas[b]*1000)}for(var b=0;b<this.verticalGridStarts.length;++b){drawLine(a,this.verticalGridStarts[b],600,this.verticalGridStarts[b]+this.verticalGridDeltas[b]*600,0)}if(!this.horizontalGridImpulse.drawHorizontal(a)){this.generateHorizontalGridImpulse()}if(!this.verticalGridImpulse.drawVertical(a)){this.generateVerticalGridImpulse()}for(var b=4;b<this.boxes.length;++b){this.boxes[b].draw(a)}};var CanvasTest=function(b){this.sizeX=1000;this.sizeY=600;this.ctx=b;this.hitEffects=new HitEffectController();var c=new b2AABB();c.minVertex.Set(-50,-50);c.maxVertex.Set(this.sizeX+50,this.sizeY+50);var f=new b2Vec2(0,0);var e=false;this.physWorld=new b2World(c,f,e);this.level=new Level(this.physWorld,this.sizeX,this.sizeY,0.8,0.95);var d=this.sizeX*this.sizeY/(1000*600);this.balls=new Array();for(var a=0;a<5;++a){this.balls[a*2+0]=new Ball(this.physWorld,this.sizeX*(0.35+a*0.07),this.sizeY*0.2,5+d*(15+a),d*500,1,1);this.balls[a*2+1]=new Ball(this.physWorld,this.sizeX*(0.35+a*0.07),this.sizeY*0.8,5+d*(15+a),d*500,1,1)}Stats=new Statistics();Stats.reset()};CanvasTest.prototype.draw=function(){var j=new Date();var h=j.getTime();var g=1/(120);var e=10;this.physWorld.Step(g,e);var j=new Date();var f=j.getTime();this.ctx.beginPath();this.ctx.rect(0,0,this.sizeX,this.sizeY);var a=this.ctx.createLinearGradient(0,this.sizeY,this.sizeX,0);a.addColorStop(0,"rgba(19,33,57,1.0)");a.addColorStop(1,"rgba(11,14,14,1.0)");this.ctx.fillStyle=a;Stats.addPrimitive();this.ctx.fill();this.level.draw(this.ctx);for(var b=0;b<this.balls.length;++b){if(this.balls[b].detectCollision()){this.hitEffects.add(this.balls[b].collisionPosition.x,this.balls[b].collisionPosition.y)}this.balls[b].draw(this.ctx)}this.hitEffects.draw(this.ctx);var j=new Date();var c=j.getTime();Stats.addFrame(f-h,c-f)};CanvasTest.prototype.getStats=function(){return Stats};